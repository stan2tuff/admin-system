<!DOCTYPE html>
<html>
<head>
    <title>CyberOS | Admin Suite</title>
    <style>
        :root { --neon: #00f2ff; --bg: #050608; --card: rgba(255,255,255,0.03); --danger: #ff4c4c; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; margin: 0; height: 100vh; }
        .sidebar { width: 280px; background: #000; padding: 30px; border-right: 1px solid #222; }
        .main { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top, #111, #050608); }
        .card { background: var(--card); border: 1px solid #333; border-radius: 15px; padding: 25px; margin-bottom: 25px; backdrop-filter: blur(10px); }
        .status-tag { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .online { background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid #00ff88; }
        .offline { background: rgba(255, 76, 76, 0.1); color: #ff4c4c; border: 1px solid #ff4c4c; }
        input { background: #000; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 10px; }
        button { background: var(--neon); color: black; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .p-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.02); margin-bottom: 8px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1 style="color: var(--neon); text-shadow: 0 0 10px var(--neon);">CYBER.OS</h1>
    <p style="font-size: 13px; color: #888;">OPERATOR: <b>{{ user }}</b></p>
    <p id="serverStatus"></p>
    <hr style="border:0; border-top:1px solid #222; margin: 20px 0;">
    <a href="/login" style="color: #555; text-decoration: none; font-size: 12px;">Switch Account</a>
</div>

<div class="main">
    {% if role == 'master' %}
    <div class="card" style="border-color: var(--danger);">
        <h3 style="color: var(--danger); margin-top:0;">Master User Registry</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="d_id" placeholder="Discord ID">
            <input type="text" id="d_name" placeholder="Name">
            <input type="text" id="g_id" placeholder="Game ID">
            <button onclick="linkUser()">AUTHORIZE</button>
        </div>
        <table style="width:100%; text-align:left;">
            <tr style="color:#555;"><th>User</th><th>Discord ID</th><th>GID</th></tr>
            {% for uid, data in all_users.items() %}
            <tr><td>{{ data.name }}</td><td>{{ uid }}</td><td>{{ data.gid }}</td></tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <div class="card">
        <h3>Server Control (GID: {{ gid }})</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="globalMsg" placeholder="Announcement Message...">
            <button id="btnMsg" onclick="sendCommand('all', 'message')">SEND ANNOUNCEMENT</button>
            <button id="btnKick" onclick="sendCommand('all', 'kickall')" style="background: var(--danger); color: white;">SHUTDOWN SERVER</button>
        </div>
    </div>

    <div class="card">
        <h3>Live Players</h3>
        <div id="playerList">Scanning Roblox servers...</div>
    </div>
</div>

<script>
    let cooldown = false;

    async function sendCommand(target, action) {
        if(cooldown) return;
        const msg = document.getElementById('globalMsg').value;
        
        cooldown = true;
        document.querySelectorAll('button').forEach(b => b.disabled = true);
        
        await fetch('/api/command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target, action, msg})
        });

        setTimeout(() => {
            cooldown = false;
            document.querySelectorAll('button').forEach(b => b.disabled = false);
        }, 3000); // 3 second anti-spam
    }

    async function refresh() {
        const res = await fetch('/api/data');
        const data = await res.json();
        
        // Update Status
        const status = document.getElementById('serverStatus');
        status.innerHTML = data.is_online ? 
            '<span class="status-tag online">SERVER ONLINE</span>' : 
            '<span class="status-tag offline">SERVER OFFLINE</span>';

        // Update Players
        const list = document.getElementById('playerList');
        list.innerHTML = data.players.length > 0 ? 
            data.players.map(p => `
                <div class="p-item">
                    <span>ðŸ‘¤ ${p}</span>
                    <button onclick="sendCommand('${p}', 'kick')" style="padding: 5px 15px; font-size: 11px; background: #333; color: white;">KICK</button>
                </div>
            `).join('') : "No active players in this GID.";
    }

    setInterval(refresh, 4000); refresh();

    async function linkUser() {
        const discord_id = document.getElementById('d_id').value;
        const username = document.getElementById('d_name').value;
        const game_id = document.getElementById('g_id').value;
        await fetch('/master/assign', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({discord_id, username, game_id})
        });
        location.reload();
    }
</script>
</body>
</html>
